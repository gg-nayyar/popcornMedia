name: CI with Keploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  keploy-test:
    runs-on: ubuntu-latest

    services:
      mongo:
        image: mongo
        ports:
          - 27017:27017

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm ci

    - name: Build the project
      run: npm run build

    - name: Start App in Background
      run: |
        nohup npm start &

    - name: Wait for server to start
      run: sleep 5

    - name: Run Keploy Tests
      run: |
        docker run \
          --network="host" \
          -v ${{ github.workspace }}:/app \
          keploy/keploy:latest \
          test \
          --test-path /app/.keploy/test \
          --app-port 8004
